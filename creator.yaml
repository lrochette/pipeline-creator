version: "1.0"

stages:
  - clone

steps:
  clone:
    title: "Cloning repository"
    type: "git-clone"
    repo: "${{ORG}}/${{REPO}}"
    revision: "master"
    stage: clone

  create_pipeline:
    title: "Creating pipeline"
    image: codefresh/cli
    working_directory: ${{REPO}}
    stage: clone
    commands:
      - |-
        echo "SPEC ${{SPEC}}"
        echo "TRIGGERS ${{TRIGGERS}}"
        process_dir() {
          echo  "process directory $1"
          for FILE in $1/* ; do
            process_file $1/$FILE
          done
        }
        process_file() {
          if [ -f $1 ]; then
            echo  "process file $1"
            yq -s -y '.[0].spec.triggers = if .[0].spec.triggers? then [.[].spec.triggers | add]  else  [.[1].spec.triggers | add] end | .[0] ' $SPEC $1 > $CF_BUILD_ID.yml
            mv $CF_BUILD_ID.yml $SPEC
            return
          fi
          if [ -d $1 ] ; then
            process_dir $1
            return
          fi
          echo "Unknown file $1 - IGNORE"
        }
        for f in `echo $TRIGGERS` ; do
            process_file $f
        done
        cat $SPEC
